name: Build

on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  wait-for-quality-gate:
    name: Wait for SonarQube Quality Gate
    runs-on: ubuntu-latest
    steps:
      - name: Poll for SonarQube Quality Gate using GitHub API
        id: quality-gate-check
        run: |
          #!/bin/bash
          set -e
          
          REPO_OWNER="${{ github.repository_owner }}"
          REPO_NAME="${{ github.event.repository.name }}"
          REF="${{ github.ref }}"
          WORKFLOW_NAME="Custom Webhook Trigger"
          MAX_WAIT_TIME=1800  # 30 minutes in seconds
          POLL_INTERVAL=10    # 10 seconds
          
          echo "üîç Polling for '$WORKFLOW_NAME' workflow completion..."
          echo "Repository: $REPO_OWNER/$REPO_NAME"
          echo "Ref: $REF"
          
          start_time=$(date +%s)
          start_time_iso=$(date -u -d "@$start_time" +"%Y-%m-%dT%H:%M:%SZ")
          echo "üìÖ Polling started at: $start_time_iso"
          
          while true; do
            current_time=$(date +%s)
            echo "current_time: $current_time, start_time: $start_time"
            elapsed_time=$((current_time - start_time))
            
            if [ $elapsed_time -gt $MAX_WAIT_TIME ]; then
              echo "‚ùå Timeout: Workflow did not complete within 30 minutes -rl"
              echo "outcome=timeout" >> $GITHUB_OUTPUT
              exit 1
            fi
            
            echo "‚è±Ô∏è  Checking workflow status... (elapsed: ${elapsed_time}s)"
            
            # Get workflow runs for the repository
            response=$(curl -s \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/$REPO_OWNER/$REPO_NAME/actions/runs?per_page=50")
            
            if [ $? -ne 0 ]; then
              echo "‚ö†Ô∏è  Failed to fetch workflow runs, retrying..."
              sleep $POLL_INTERVAL
              continue
            fi
            
            # Debug: Check if response contains workflow_runs
            workflow_runs_count=$(echo "$response" | jq -r '.workflow_runs | length // 0')
            echo "üìã Found $workflow_runs_count total workflow runs"
            
            # Find the most recent Custom Webhook Trigger workflow run that has completed
            workflow_run=$(echo "$response" | jq -r --arg workflow_name "$WORKFLOW_NAME" --arg start_time "$start_time_iso" '
              [.workflow_runs[]? | 
              select(.name == $workflow_name) |
              select(.status == "completed") |
              select(.created_at > $start_time)] |
              if length > 0 then
                sort_by(.created_at) | reverse | .[0]
              else
                null
              end')
            
            if [ "$workflow_run" != "null" ] && [ -n "$workflow_run" ]; then
              conclusion=$(echo "$workflow_run" | jq -r '.conclusion // "unknown"')
              run_id=$(echo "$workflow_run" | jq -r '.id // "unknown"')
              created_at=$(echo "$workflow_run" | jq -r '.created_at // "unknown"')
              
              echo "‚úÖ Workflow run found (ID: $run_id, Created: $created_at)"
              echo "üìä Conclusion: $conclusion"
              
              if [ "$conclusion" = "success" ]; then
                echo "üéâ Quality Gate passed! Proceeding to build..."
                echo "outcome=success" >> $GITHUB_OUTPUT
                exit 0
              elif [ "$conclusion" = "failure" ]; then
                echo "‚ùå Quality Gate failed!"
                echo "outcome=failure" >> $GITHUB_OUTPUT
                exit 0
              elif [ "$conclusion" = "cancelled" ]; then
                echo "üö´ Quality Gate workflow was cancelled"
                echo "outcome=cancelled" >> $GITHUB_OUTPUT
                exit 1
              else
                echo "‚ö†Ô∏è  Unexpected conclusion: $conclusion"
                echo "outcome=unknown" >> $GITHUB_OUTPUT
                exit 1
              fi
            else
              echo "‚è≥ No completed '$WORKFLOW_NAME' workflow found yet, waiting $POLL_INTERVAL seconds..."
              sleep $POLL_INTERVAL
            fi
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Check Quality Gate Result
        run: |
          outcome="${{ steps.quality-gate-check.outputs.outcome }}"
          
          if [ "$outcome" = "failure" ]; then
            echo "BUILD FAILED: SONARQUBE QUALITY GATE IS FAILING"
            exit 1
          elif [ "$outcome" = "success" ]; then
            echo "‚úÖ Quality Gate verification completed successfully"
            echo "Proceeding to build step..."
          elif [ "$outcome" = "timeout" ] || [ "$outcome" = "cancelled" ] || [ "$outcome" = "unknown" ]; then
            echo "BUILD FAILED: Quality Gate check did not complete successfully (Status: $outcome)"
            exit 1
          else
            echo "BUILD FAILED: Unexpected Quality Gate status: $outcome"
            exit 1
          fi

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: wait-for-quality-gate
    
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: 'zulu' # Alternative distribution options are available.
      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2
      - name: Build
        run: mvn -B clean compile test package
